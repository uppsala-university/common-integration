<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd http://aries.apache.org/xmlns/jpa/v1.1.0 http://aries.apache.org/schemas/jpa/jpa_110.xsd"
default-activation="eager">

	<!-- Properties from /opt/servicemix/apache-servicemix-5.4.0/etc/se.uu.its.integration.uu-integration.cfg -->
    <cm:property-placeholder persistent-id="se.uu.its.integration.esb-datasource-logdb">
        <cm:default-properties>
            <cm:property name="ds.pw" value="foobar"/>
            <cm:property name="ds.host" value="localhost"/>
            <cm:property name="ds.port" value="3306"/>
        </cm:default-properties>
    </cm:property-placeholder>

	<!--
	 	 Following configuration are based on below links. 
	 
	 	 Due to bug ENTESB-633 JDBC XA resources wont automatically register into the transaction manager
	 	 and need to be handled by programming configurations.
	 	
	 	 TODO: The bug is documented to be corrected in JBoss Fuse 6.1 and affects 7.1. Which SMX components
	 	 and versions that are involved in correction needs to be clarified. 
	 
		 Links:
		 	https://github.com/FuseByExample/esb-transactions/blob/master/datasource/src/main/resources/OSGI-INF/blueprint/datasource.xml
			https://github.com/tmielke/fuse-demos/blob/master/Camel/Camel-JMS-JDBC-XA-TX-JBossFuse6.0/datasource/src/main/resources/OSGI-INF/blueprint/datasource.xml
	-->

	<!-- This is the same transaction manager pointed out by the ActiveMQ resource manager delared and defined in route. -->
	<reference id="recoverableTxManager" interface="org.apache.geronimo.transaction.manager.RecoverableTransactionManager" />

	<!-- Sets up a Geronimo JCA connection manager which also supports pooling -->
	<bean id="connectionManager"
		class="org.apache.geronimo.connector.outbound.GenericConnectionManager">
		<argument index="0">
			<bean
				class="org.apache.geronimo.connector.outbound.connectionmanagerconfig.XATransactions">
				<argument value="true" />
				<argument value="false" />
			</bean>
		</argument>
		<argument index="1">
			<!-- http://geronimo.apache.org/maven/server/modules/geronimo-connector/apidocs/org/apache/geronimo/connector/outbound/connectionmanagerconfig/PartitionedPool.html -->
			<bean
				class="org.apache.geronimo.connector.outbound.connectionmanagerconfig.PartitionedPool">
				<argument value="10" />
				<argument value="0" />
				<argument value="5000" />
				<argument value="15" />
				<argument value="true" />
				<argument value="false" />
				<argument value="false" />
				<argument value="true" />
				<argument value="false" />
			</bean>
		</argument>
		<argument index="2">
			<null />
		</argument>
		<argument index="3">
			<null />
		</argument>
		<argument index="4" ref="recoverableTxManager" />
		<argument index="5" value="MariaDB" />
		<argument index="6" ref="classLoader" />
	</bean>

	<bean id="classLoader" class="org.apache.aries.util.AriesFrameworkUtil"
		factory-method="getClassLoader">
		<argument ref="blueprintBundle" />
	</bean>
	<service ref="classLoader" auto-export="all-classes" />

	<!-- 
		 Tranql provides the ManagedConnectionFactory but delegates all the 
		 work to the JDBC drivers. There are factories for every major JDBC provider 
		 at http://search.maven.org/#search|ga|1|tranql-connector You would need to 
		 configure your JDBC provider here. 
	-->
	<bean id="jdbcManagedConnectionFactory" class="org.tranql.connector.mysql.XAMCF">
		<property name="databaseName" value="logdb" />
		<property name="userName" value="idintegration"/>
		<property name="password" value="${ds.pw}" />
		<property name="serverName" value="${ds.host}" />
		<property name="portNumber" value="${ds.port}" />
	</bean>
	
	<!-- Creates the JDBC ConnectionFactory -->
	<bean id="mariadbConnectionFactory" factory-ref="jdbcManagedConnectionFactory"
		factory-method="createConnectionFactory">
		<argument ref="connectionManager" />
	</bean>

	<!-- Exports the JDBC ConnectionFactory -->
	<service ref="mariadbConnectionFactory" interface="javax.sql.DataSource">
		<service-properties>
			<entry key="osgi.jndi.service.name" value="jdbc/UUDS" />
			<entry key="datasource.name" value="MariaDB" />
		</service-properties>
	</service>

    <!-- This is how configuration "should" look like with bug ENTESB-633 corrected.
    <bean id="dataSource" class="com.mysql.jdbc.jdbc2.optional.MysqlXADataSource">
    	<property name="databaseName" value="logdb"/>
        <property name="url" value="jdbc:mysql://localhost:3306/logdb?relaxAutoCommit=true"/>
        <property name="user" value="idintegration"/>
        <property name="password" value="foobar"/>
    </bean>

    <service interface="javax.sql.XADataSource" ref="dataSource">
         <service-properties>
            <entry key="osgi.jndi.service.name" value="jdbc/UUDS"/>
            <entry key="datasource.name" value="MariaDB"/>
        </service-properties>
    </service>
 	-->
 	
</blueprint>
